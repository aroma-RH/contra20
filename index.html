<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقاط وإرسال صورة</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
</head>
<body>

    <video id="camera" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <button id="capture">التقاط الصورة</button>
    <button id="send" style="display: none;">إرسال إلى Telegram</button>
    <br>
    <label for="tarea" class="animated-label">Tarea:</label>
    <select id="message" name="tarea" required></select><br><br>
    <br>
    

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        const video = document.getElementById("camera");
        const canvas = document.getElementById("canvas");
        const captureButton = document.getElementById("capture");
        const sendButton = document.getElementById("send");
        const ctx = canvas.getContext("2d");
        const messageInput = document.getElementById("message");

        // تفعيل الكاميرا الخلفية
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            const rearCamera = videoDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear'));
            const constraints = {
                video: {
                    deviceId: rearCamera ? { exact: rearCamera.deviceId } : undefined
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => video.srcObject = stream)
                .catch(err => console.error("خطأ في تشغيل الكاميرا:", err));
        });

        // التقاط الصورة
        captureButton.addEventListener("click", () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            sendButton.style.display = "block";
        });

        // إرسال الصورة إلى Telegram
        sendButton.addEventListener("click", () => {
            const message = messageInput.value;  // الحصول على نص الإدخال

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append("chat_id", "-1002408201424");  // استبدل بـ Chat ID الخاص بك
                formData.append("photo", blob, "photo.jpg");
                formData.append("caption", message);  // إرسال النص مع الصورة

                fetch("https://api.telegram.org/bot7914915084:AAFy5X26pPqYwDJU84jgBWWRt_7PqgPBvQg/sendPhoto", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(data => console.log("تم الإرسال:", data))
                .catch(error => console.error("خطأ أثناء الإرسال:", error));
            }, "image/jpeg");
        });

        // جلب البيانات من Google Apps Script وتعبئة الـ Select
        fetch('https://script.google.com/macros/s/AKfycbyM43VhZiCVEbOvWpT8klFJDkFU911bdWvFZnLvmFeCCSw6LtpbCMIdtOSHED_BzsGxuw/exec')
            .then(response => response.json())
            .then(data => {
                const comboBox = document.getElementById('message');
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    comboBox.appendChild(option);
                });

                // تفعيل البحث في القائمة باستخدام Choices.js
                const choices = new Choices('#message', {
                    searchEnabled: true,
                    placeholder: true,
                    placeholderValue: 'اختر Tarea'
                });
            })
            .catch(error => console.error("حدث خطأ في تحميل البيانات:", error));

    </script>

</body>
</html>
