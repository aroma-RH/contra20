<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <style>
       body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 20px;
    min-height: 100vh;
}

.container {
    max-width: 800px;
    margin: 0 auto;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 24px;
}

h2 {
    text-align: center;
    color: #333;
    margin-bottom: 24px;
}

.form-group {
    margin-bottom: 16px;
}

select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s;
}

select:focus {
    border-color: #4299e1;
    outline: none;
}

.file-upload {
    position: relative;
    margin-bottom: 16px;
}

.upload-btn {
    width: 100%;
    padding: 12px;
    background-color: #48bb78;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.upload-btn:hover {
    background-color: #38a169;
}

input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.images-container {
    display: grid;
    gap: 16px;
    margin-bottom: 16px;
}

.image-wrapper {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e2e8f0;
    transition: border-color 0.2s;
    padding-bottom: 60px;
}

.image-wrapper.confirmed {
    border-color: #48bb78;
}

.image-wrapper img {
    width: 100%;
    display: block;
}

.image-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 8px;
    border: none;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.action-btn:hover {
    background-color: rgba(0, 0, 0, 0.9);
}

.action-btn.delete:hover {
    background-color: #e53e3e;
}

.action-btn.confirm:hover {
    background-color: #38a169;
}

.worker-select-container {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 8px;
    background-color: #f8fafc;
    border-top: 1px solid #e2e8f0;
}

.worker-select {
    width: 100%;
}

.confirmation-badge {
    position: absolute;
    bottom: 70px;
    right: 8px;
    background-color: #48bb78;
    color: white;
    padding: 4px 8px;
    border-radius: 16px;
    font-size: 14px;
}

.send-button {
    width: 100%;
    padding: 12px;
    background-color: #4299e1;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.send-button:hover {
    background-color: #3182ce;
}

.send-button .icon {
    font-size: 20px;
}

.hidden {
    display: none;
}

/* Select2 customization */
.select2-container {
    width: 100% !important;
}

.select2-container--default .select2-selection--single {
    height: 42px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 42px;
    padding-left: 12px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 40px;
}

.select2-dropdown {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
}

.select2-search__field {
    padding: 8px !important;
    border-radius: 4px !important;
}

.select2-results__option {
    padding: 8px 12px !important;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #4299e1;
}
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h2>SUIVI LES CONTRAT</h2>
        
        <form id="contractForm">
            <div class="form-group">
                <select id="group" name="group" required>
                    <option value="">Select Group</option>
                    <option value="-1001787397401">AGRI STRATEGIE</option>
                    <option value="-1001857451298">AGRI SUPPORT</option>
                    <option value="-4179123948">BEST PROFIL</option>
                    <option value="-1002080960662">AGRICONOMIE</option>
                    <option value="-1002032761527">FARM LABOUR</option>
                </select>
            </div>

            <div class="form-group">
                <select id="finca" name="finca" required>
                    <option value="">Select Finca</option>
                    <option value="FINCA 1">FINCA 1</option>
                    <option value="FINCA 2">FINCA 2</option>
                    <option value="FINCA 3">FINCA 3</option>
                    <option value="FINCA 4">FINCA 4</option>
                    <option value="FINCA 5">FINCA 5</option>
                    <option value="FINCA 6">FINCA 6</option>
                    <option value="FINCA 8">FINCA 8</option>
                    <option value="FINCA 9">FINCA 9</option>
                    <option value="FINCA 13">FINCA 13</option>
                    <option value="FINCA 19">FINCA 19</option>
                    <option value="FINCA 20">FINCA 20</option>
                    <option value="FINCA 21">FINCA 21</option>
                    <option value="FINCA 22">FINCA 22</option>
                </select>
            </div>

            <div class="form-group">
                <select id="worker" name="worker" ></select>
            </div>

            <div class="file-upload">
                <button type="button" class="upload-btn">SÃ©lectionnez les contrats</button>
                <input type="file" id="imageInput" accept="image/*" multiple>
            </div>

            <div id="imagesContainer" class="images-container"></div>

            <button type="submit" id="sendButton" class="send-button hidden">
                <span class="icon">ðŸ“¤</span>
                Envoyer (<span id="imageCount">0</span> images)
            </button>
        </form>
    </div>
</div>

<script>
  class ContractManager {
    constructor() {
        this.images = new Map();
        this.initializeElements();
        this.setupEventListeners();
        this.loadWorkers();
        this.initializeSelect2();
        this.workers = [];
    }

    initializeElements() {
        this.form = document.getElementById('contractForm');
        this.imageInput = document.getElementById('imageInput');
        this.imagesContainer = document.getElementById('imagesContainer');
        this.sendButton = document.getElementById('sendButton');
        this.imageCountSpan = document.getElementById('imageCount');
        this.workerSelect = document.getElementById('worker');
    }

    setupEventListeners() {
        this.imageInput.addEventListener('change', this.handleImageUpload.bind(this));
        this.form.addEventListener('submit', this.handleFormSubmit.bind(this));
    }

    initializeSelect2() {
        $(this.workerSelect).select2({
            placeholder: "Search and select default worker...",
            allowClear: true
        });

        $(this.workerSelect).on('change', (e) => {
            const selectedWorker = e.target.value;
            if (selectedWorker) {
                this.images.forEach(image => {
                    if (!image.worker) {
                        image.worker = selectedWorker;
                        this.renderImages();
                    }
                });
            }
        });
    }

    async loadWorkers() {
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbwAiB1V0BBGSUkXQFnw351xoGMlmD_wBSzHviJwoLOAuSi9rAlSMCjfpd5T2ohdgBsyZA/exec');
            this.workers = await response.json();
            
            this.workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker;
                option.textContent = worker;
                this.workerSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading workers:", error);
        }
    }

    initializeImageSelect2(selectElement, imageId) {
        $(selectElement).select2({
            placeholder: "Search and select worker...",
            allowClear: true,
            data: this.workers.map(worker => ({
                id: worker,
                text: worker
            }))
        }).on('change', (e) => {
            const image = this.images.get(imageId);
            if (image) {
                image.worker = e.target.value;
            }
        });
    }

    handleImageUpload(event) {
        const files = event.target.files;
        if (!files) return;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            const imageId = Math.random().toString(36).substring(7);

            reader.onloadend = () => {
                this.images.set(imageId, {
                    id: imageId,
                    dataUrl: reader.result,
                    file: file,
                    confirmed: false,
                    worker: this.workerSelect.value || null
                });
                this.renderImages();
            };

            reader.readAsDataURL(file);
        });
    }

    renderImages() {
        this.imagesContainer.innerHTML = '';
        let confirmedCount = 0;

        this.images.forEach(image => {
            if (image.confirmed) confirmedCount++;

            const wrapper = document.createElement('div');
            wrapper.className = `image-wrapper ${image.confirmed ? 'confirmed' : ''}`;
            
            const selectId = `worker-select-${image.id}`;
            
            wrapper.innerHTML = `
                <img src="${image.dataUrl}" alt="Contract">
                <div class="image-actions">
                    <button type="button" class="action-btn delete" data-id="${image.id}">ðŸ—‘</button>
                    ${!image.confirmed ? `<button type="button" class="action-btn confirm" data-id="${image.id}">âœ“</button>` : ''}
                </div>
                <div class="worker-select-container">
                    <select id="${selectId}" class="worker-select"></select>
                </div>
                ${image.confirmed ? '<div class="confirmation-badge">Confirmed</div>' : ''}
            `;

            wrapper.querySelector('.delete').addEventListener('click', () => this.deleteImage(image.id));
            const confirmBtn = wrapper.querySelector('.confirm');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => this.confirmImage(image.id));
            }

            this.imagesContainer.appendChild(wrapper);

            const selectElement = document.getElementById(selectId);
            this.initializeImageSelect2(selectElement, image.id);
            if (image.worker) {
                $(selectElement).val(image.worker).trigger('change');
            }
        });

        this.imageCountSpan.textContent = confirmedCount;
        this.sendButton.classList.toggle('hidden', confirmedCount === 0);
    }

    deleteImage(imageId) {
        this.images.delete(imageId);
        this.renderImages();
    }

    confirmImage(imageId) {
        const image = this.images.get(imageId);
        if (image) {
            if (!image.worker) {
                alert("Please select a worker before confirming the image.");
                return;
            }
            image.confirmed = true;
            this.renderImages();
        }
    }

    async handleFormSubmit(event) {
        event.preventDefault();

        const groupId = document.getElementById('group').value;
        const finca = document.getElementById('finca').value;

        if (!groupId || !finca || this.images.size === 0) {
            alert("Please fill in all fields and select at least one contract before sending.");
            return;
        }

        const confirmedImages = Array.from(this.images.values()).filter(img => img.confirmed);
        if (confirmedImages.length === 0) {
            alert("Please confirm at least one image before sending.");
            return;
        }

        try {
            // Send all confirmed images to Telegram
            for (const image of confirmedImages) {
                const response = await fetch(image.dataUrl);
                const blob = await response.blob();
                const telegramFormData = new FormData();
                telegramFormData.append("chat_id", groupId);
                telegramFormData.append("photo", blob, "photo.jpg");
                telegramFormData.append("caption", `${image.worker} ( ${finca} )`);

                await fetch("https://api.telegram.org/bot7561853556:AAElzI6FYzNb6yNUV6EA_Bnzkec2hUrcP70/sendPhoto", {
                    method: "POST",
                    body: telegramFormData
                });
            }

            // Update Google Sheets for each confirmed image
            for (const image of confirmedImages) {
                const [workerId, ...workerNameArr] = image.worker.split(' ');
                const workerName = workerNameArr.join(' ');

                const sheetsFormData = new FormData();
                sheetsFormData.append("group", groupId);
                sheetsFormData.append("finca", finca);
                sheetsFormData.append("workerId", workerId);
                sheetsFormData.append("workerName", workerName);

                await Promise.all([
                    fetch("https://script.google.com/macros/s/AKfycbzZjmo1PoWxpuxe1hOBasi2c2tlsa5cn2iWlwOQZk6jdIgeWchfFC5Juk3vEhAqu7QE/exec", {
                        method: "POST",
                        body: sheetsFormData
                    }),
                    fetch("https://script.google.com/macros/s/AKfycbzIKjHqFywsBNy_SZOlhhVpOsVm_HnlW7H9-qwWcVm73FYaqz0Pu-i3bI1a9tyJ2DQd/exec", {
                        method: "POST",
                        body: new FormData().append("workerId", workerId)
                    })
                ]);
            }

            alert("Contracts sent successfully!");
            this.images.clear();
            this.renderImages();
            this.workerSelect.value = '';
            $(this.workerSelect).trigger('change');
        } catch (error) {
            console.error("Error sending contracts:", error);
            alert("Error sending contracts. Please try again.");
        }
    }
}

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    new ContractManager();
});
</script>

</body>
</html>
