<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choisir et Envoyer des Images</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <style>
        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù€ Select */
        select {
            width: 350px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ccc;
            font-size: 16px;
            background-color: #fff;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        select:focus {
            border-color: #007BFF;
            outline: none;
        }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ØµÙˆØ± */
        #image-previews {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            margin-top: 20px;
        }

        .preview-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .preview-container img {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        button {
            background-color: #007BFF;
            color: white;
            font-size: 16px;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .hidden {
            display: none;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        .button-group button {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            font-size: 14px;
            color: white;
            border-radius: 5px;
        }

        .button-group button:hover {
            background-color: rgba(255, 0, 0, 0.8);
        }

        /* Ø§Ù„Ù†ØµÙˆØµ */
        .text {
            font-size: 14px;
            color: #777;
        }
    </style>
</head>
<body>

<h2>Choisir et Envoyer des Images</h2>

<!-- SÃ©lectionner le groupe Telegram -->
<label for="group">SÃ©lectionner le groupe :</label>
<select id="group">
    <option value="-1002408201424">AGRI STRATEGIE</option>
    <option value="-1000987654321">AGRI SUPPORT</option>
    <option value="-1002408201424">BEST PROFIL</option>
    <option value="-1002233445566">AGRICONOMIE</option>
    <option value="-1003344556677">FARM LABOUR</option>
</select>

<!-- SÃ©lectionner la finca -->
<select id="finca">
    <option value="FINCA 1">FINCA 1</option>
    <option value="FINCA 2">FINCA 2</option>
    <option value="FINCA 3">FINCA 3</option>
    <option value="FINCA 4">FINCA 4</option>
    <option value="FINCA 5">FINCA 5</option>
</select>

<!-- Choisir des images -->
<input type="file" id="imageInput" accept="image/*" multiple>

<!-- PrÃ©visualisation des images -->
<div id="preview-container" class="hidden">
    <div id="image-previews"></div>
</div>

<!-- Envoyer les images -->
<button id="send" class="hidden">ðŸ“¤ Envoyer Ã  Telegram</button>

<button id="reload" >ðŸ”„ Recharger la Page</button>

<script>
    const imageInput = document.getElementById("imageInput");
    const previewContainer = document.getElementById("preview-container");
    const sendButton = document.getElementById("send");
    const reloadButton = document.getElementById("reload");
    const imagePreviews = document.getElementById("image-previews");
    const groupSelect = document.getElementById("group");
    const fincaSelect = document.getElementById("finca");

    let images = JSON.parse(localStorage.getItem("images")) || [];

    // ðŸ”¹ RÃ©initialiser la page tout en conservant les images
    reloadButton.addEventListener("click", () => {
        localStorage.removeItem("images");
        window.location.reload();
    });

    // ðŸ”¹ Charger les images sauvegardÃ©es au chargement de la page
    function loadSavedImages() {
        if (images.length > 0) {
            images.forEach(({ src, workerSelect }) => {
                const previewDiv = document.createElement("div");
                previewDiv.classList.add("preview-container");

                const img = document.createElement("img");
                img.src = src;

                const workerSelectElement = document.createElement("select");
                workerSelectElement.innerHTML = `<option value="">SÃ©lectionner un ouvrier</option>`;

                // Ajouter les ouvriers
                fetch('https://script.google.com/macros/s/AKfycbwAiB1V0BBGSUkXQFnw351xoGMlmD_wBSzHviJwoLOAuSi9rAlSMCjfpd5T2ohdgBsyZA/exec')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            option.textContent = item;
                            workerSelectElement.appendChild(option);
                        });

                        // Activation de la recherche
                        $(workerSelectElement).select2({
                            placeholder: 'SÃ©lectionner un ouvrier',
                            allowClear: true
                        });
                    })
                    .catch(error => console.error("Erreur de chargement des ouvriers:", error));

                previewDiv.appendChild(img);
                previewDiv.appendChild(workerSelectElement);

                imagePreviews.appendChild(previewDiv);
            });

            previewContainer.classList.remove("hidden");
            sendButton.classList.remove("hidden");
        }
    }

    // ðŸ”¹ SÃ©lectionner des images
    imageInput.addEventListener("change", (event) => {
        imagePreviews.innerHTML = '';  // Clear previous previews
        const files = event.target.files;
        const newImages = [];

        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const previewDiv = document.createElement("div");
                previewDiv.classList.add("preview-container");

                const img = document.createElement("img");
                img.src = reader.result;

                const workerSelect = document.createElement("select");
                workerSelect.innerHTML = `<option value="">SÃ©lectionner un ouvrier</option>`;

                // Ajouter les ouvriers
                fetch('https://script.google.com/macros/s/AKfycbwAiB1V0BBGSUkXQFnw351xoGMlmD_wBSzHviJwoLOAuSi9rAlSMCjfpd5T2ohdgBsyZA/exec')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            option.textContent = item;
                            workerSelect.appendChild(option);
                        });

                        // Activation de la recherche
                        $(workerSelect).select2({
                            placeholder: 'SÃ©lectionner un ouvrier',
                            allowClear: true
                        });
                    })
                    .catch(error => console.error("Erreur de chargement des ouvriers:", error));

                previewDiv.appendChild(img);
                previewDiv.appendChild(workerSelect);
                imagePreviews.appendChild(previewDiv);

                // Sauvegarder dans le LocalStorage
                newImages.push({ src: reader.result, workerSelect });
            };
            reader.readAsDataURL(file);
        });

        images = newImages;
        localStorage.setItem("images", JSON.stringify(images));

        previewContainer.classList.remove("hidden");
        sendButton.classList.remove("hidden");
    });

    // ðŸ”¹ Envoyer les images et les ouvriers Ã  Telegram
    sendButton.addEventListener("click", () => {
        const groupId = groupSelect.value;
        const finca = fincaSelect.value;

        if (images.length === 0) {
            alert("Veuillez sÃ©lectionner des images avant d'envoyer.");
            return;
        }

        images.forEach(({ src, workerSelect }) => {
            const workerName = workerSelect.value;
            if (!workerName) {
                alert("Veuillez sÃ©lectionner un ouvrier pour chaque image.");
                return;
            }

            const formData = new FormData();
            formData.append("chat_id", groupId);
            formData.append("photo", src, src.name);
            formData.append("caption", `Ouvrier: ${workerName} ( ${finca} )`);

            fetch("https://api.telegram.org/bot7914915084:AAFy5X26pPqYwDJU84jgBWWRt_7PqgPBvQg/sendPhoto", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => console.log("Envoi rÃ©ussi:", data))
            .catch(error => console.error("Erreur lors de l'envoi:", error));
        });
    });

    // Charger les images au chargement de la page
    loadSavedImages();
</script>

</body>
</html>
